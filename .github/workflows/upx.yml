name: Ultimate Obfuscated Build (All-in-One)

on:
  schedule:
    - cron: '0 4 * * 0' # 每周日凌晨4点运行
  workflow_dispatch:    # 支持手动触发

jobs:
  # ==========================================
  # 任务 1: 编译混淆 Cloudflared (伪装名: bot)
  # ==========================================
  build-cloudflared:
    name: Build Cloudflared
    runs-on: ubuntu-latest
    steps:
      - name: Setup Latest Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable' # 关键修改：自动使用最新稳定版 (如 1.25+)
          check-latest: true   # 强制检查最新版本，防止缓存旧版

      - name: Install Tools
        run: |
          go install mvdan.cc/garble@latest
          sudo apt-get update && sudo apt-get install -y upx

      - name: Clone Cloudflared
        run: |
          TAG=$(curl -s https://api.github.com/repos/cloudflare/cloudflared/releases/latest | jq -r .tag_name)
          echo "Building version: $TAG"
          git clone --depth 1 --branch $TAG https://github.com/cloudflare/cloudflared.git src

      - name: Mod Source & Compile
        working-directory: src
        run: |
          # 源码特征修改
          grep -rl "Cloudflare Tunnel client" . | xargs sed -i 's/Cloudflare Tunnel client/System Optimization Daemon/g'
          
          # 混淆编译 (amd64)
          echo "Compiling amd64..."
          GOOS=linux GOARCH=amd64 garble -tiny -literals build -trimpath -ldflags="-s -w" -o ../bot-amd64 ./cmd/cloudflared
          
          # 混淆编译 (arm64)
          echo "Compiling arm64..."
          GOOS=linux GOARCH=arm64 garble -tiny -literals build -trimpath -ldflags="-s -w" -o ../bot-arm64 ./cmd/cloudflared

      - name: UPX Compression
        run: upx --best --lzma bot-amd64 bot-arm64

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cloudflared-bin
          path: bot-*

  # ==========================================
  # 任务 2: 编译混淆 Xray (伪装名: web)
  # ==========================================
  build-xray:
    name: Build Xray
    runs-on: ubuntu-latest
    steps:
      - name: Setup Latest Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable' # 关键修改
          check-latest: true

      - name: Install Tools
        run: |
          go install mvdan.cc/garble@latest
          sudo apt-get install -y upx

      - name: Clone Xray-core
        run: |
          TAG=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r .tag_name)
          echo "Building version: $TAG"
          git clone --depth 1 --branch $TAG https://github.com/XTLS/Xray-core.git src

      - name: Compile
        working-directory: src
        run: |
          # 混淆编译 (amd64)
          GOOS=linux GOARCH=amd64 garble -tiny -literals build -trimpath -ldflags="-s -w" -o ../web-amd64 ./main
          # 混淆编译 (arm64)
          GOOS=linux GOARCH=arm64 garble -tiny -literals build -trimpath -ldflags="-s -w" -o ../web-arm64 ./main

      - name: UPX Compression
        run: upx --best --lzma web-amd64 web-arm64

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xray-bin
          path: web-*

  # ==========================================
  # 任务 3: 编译混淆 Nezha Agent (伪装名: npm)
  # ==========================================
  build-nezha:
    name: Build Nezha Agent
    runs-on: ubuntu-latest
    steps:
      - name: Setup Latest Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable' # 关键修改
          check-latest: true

      - name: Install Tools
        run: |
          go install mvdan.cc/garble@latest
          sudo apt-get install -y upx

      - name: Clone Nezha Agent
        run: |
          TAG=$(curl -s https://api.github.com/repos/nezhahq/agent/releases/latest | jq -r .tag_name)
          echo "Building version: $TAG"
          git clone --depth 1 --branch $TAG https://github.com/nezhahq/agent.git src

      - name: Compile
        working-directory: src
        run: |
          # 混淆编译 (amd64)
          GOOS=linux GOARCH=amd64 garble -tiny -literals build -trimpath -ldflags="-s -w" -o ../npm-amd64 ./cmd/agent
          # 混淆编译 (arm64)
          GOOS=linux GOARCH=arm64 garble -tiny -literals build -trimpath -ldflags="-s -w" -o ../npm-arm64 ./cmd/agent

      - name: UPX Compression
        run: upx --best --lzma npm-amd64 npm-arm64

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nezha-bin
          path: npm-*

  # ==========================================
  # 任务 4: 统一发布 (Release)
  # ==========================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-cloudflared, build-xray, build-nezha]
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare Files
        run: |
          mkdir -p release_files
          mv ./artifacts/cloudflared-bin/* release_files/
          mv ./artifacts/xray-bin/* release_files/
          mv ./artifacts/nezha-bin/* release_files/
          
          echo "Files prepared:"
          ls -R release_files/

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest-obfuscated
          name: "Obfuscated Tools Collection (Stable Go Build)"
          files: release_files/*
          draft: false
          prerelease: false
          allow_updates: true
