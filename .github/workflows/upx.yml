name: Advanced Obfuscated Build

on:
  schedule:
    - cron: '0 2 * * 0' # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨æž„å»º
  workflow_dispatch:    # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  # ä¼ªè£…åŽçš„ç¨‹åºå
  BINARY_NAME: "php-fpm-worker"
  # ä¼ªè£…åŽçš„ç‰ˆæœ¬å·
  FAKE_VERSION: "7.4.33"

jobs:
  build:
    name: Build and Obfuscate
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Your Repo
        uses: actions/checkout@v4

      - name: Setup Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          check-latest: true

      - name: Install Obfuscation Tools (Garble & UPX)
        run: |
          echo "Installing Garble..."
          go install mvdan.cc/garble@latest
          echo "Installing UPX..."
          sudo apt-get update && sudo apt-get install -y upx

      - name: Clone Upstream Cloudflared
        run: |
          echo "Fetching latest cloudflared tag..."
          LATEST_TAG=$(curl -s https://api.github.com/repos/cloudflare/cloudflared/releases/latest | jq -r .tag_name)
          echo "Latest version is $LATEST_TAG"
          git clone --depth 1 --branch $LATEST_TAG https://github.com/cloudflare/cloudflared.git upstream_src
          
          # è®°å½•çœŸå®žç‰ˆæœ¬å·å¤‡ç”¨
          echo "REAL_VERSION=$LATEST_TAG" >> $GITHUB_ENV

      - name: ðŸ˜ˆ Deep Clean & Rename (Source Modification)
        working-directory: upstream_src
        run: |
          echo "Starting source code modification..."
          
          # 1. ä¿®æ”¹æ¨¡å—æè¿° (è™½ç„¶Garbleä¼šåšï¼Œä½†åŒé‡ä¿é™©)
          # è¿™é‡Œçš„sedæ¯”è¾ƒå±é™©ï¼Œæˆ‘ä»¬åªä¿®æ”¹ç”¨æˆ·å¯è§çš„ Help ä¿¡æ¯
          
          # æ›¿æ¢ Usage é‡Œçš„ Cloudflare Tunnel client ä¸º System Optimization Daemon
          grep -rl "Cloudflare Tunnel client" . | xargs sed -i 's/Cloudflare Tunnel client/System Optimization Daemon/g'
          
          # æ›¿æ¢ help é‡Œçš„ cloudflared ä¸º php-fpm-worker
          grep -rl "cloudflared" cmd/ | xargs sed -i "s/cloudflared/${{ env.BINARY_NAME }}/g"
          
          # æ³¨æ„ï¼šä¸ºäº†ä¿è¯è¿žæŽ¥æˆåŠŸï¼Œæˆ‘ä»¬ä¸ä¿®æ”¹ api.cloudflare.com ç­‰æ ¸å¿ƒç½‘ç»œåº“ä»£ç 
          # å­—ç¬¦ä¸²æ··æ·†å·¥ä½œäº¤ç»™ garble -literals å¤„ç†
          
          echo "Source code modified successfully."

      - name: ðŸ”¨ Compile with Garble (AMD64)
        working-directory: upstream_src
        env:
          GOOS: linux
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          echo "Building for AMD64..."
          # -tiny: ä¼˜åŒ–ä½“ç§¯
          # -literals: æ··æ·†æ‰€æœ‰å­—ç¬¦ä¸²ï¼ˆå…³é”®ï¼ï¼‰
          # -trimpath: ç§»é™¤è·¯å¾„ç‰¹å¾
          # -ldflags: ç§»é™¤ç¬¦å·è¡¨ï¼Œæ³¨å…¥ä¼ªé€ ç‰ˆæœ¬å·
          
          garble -tiny -literals build \
            -trimpath \
            -ldflags="-s -w -X 'main.Version=${{ env.FAKE_VERSION }}' -X 'main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)'" \
            -o ../release_dist/amd64/bot \
            ./cmd/cloudflared

      - name: ðŸ”¨ Compile with Garble (ARM64)
        working-directory: upstream_src
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          echo "Building for ARM64..."
          garble -tiny -literals build \
            -trimpath \
            -ldflags="-s -w -X 'main.Version=${{ env.FAKE_VERSION }}' -X 'main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)'" \
            -o ../release_dist/arm64/bot \
            ./cmd/cloudflared

      - name: ðŸ“¦ UPX Compression
        run: |
          echo "Compressing binaries..."
          upx --best --lzma release_dist/amd64/bot
          upx --best --lzma release_dist/arm64/bot

      - name: ðŸš€ Verify & Generate Info
        run: |
          echo "Verifying builds..."
          ls -lh release_dist/amd64/bot
          ls -lh release_dist/arm64/bot
          
          # ç”Ÿæˆä¸€ä¸ªç®€å•çš„æ ¡éªŒæ–‡ä»¶
          cd release_dist
          sha256sum amd64/bot arm64/bot > checksums.txt

      - name: ðŸŽ‰ Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: custom-build
          name: "Custom Build (Based on ${{ env.REAL_VERSION }})"
          files: |
            release_dist/amd64/bot
            release_dist/arm64/bot
            release_dist/checksums.txt
          draft: false
          prerelease: false
          allow_updates: true
