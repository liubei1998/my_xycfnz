name: Custom Name Obfuscated Build (xy/cf/nz)

on:
  schedule:
    - cron: '0 4 * * 0' # 每周日凌晨4点运行
  workflow_dispatch:    # 支持手动触发

jobs:

# ==========================================
  # 任务 1: 编译 Cloudflared (输出为 cf) [内存救援版]
  # ==========================================
  build-cloudflared:
    name: Build Cloudflared (cf)
    runs-on: ubuntu-latest
    steps:
      - name: Setup Latest Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          check-latest: true

      - name: Install Tools
        run: |
          go install mvdan.cc/garble@latest
          sudo apt-get update && sudo apt-get install -y upx

      - name: Clone Cloudflared
        run: |
          TAG=$(curl -s https://api.github.com/repos/cloudflare/cloudflared/releases/latest | jq -r .tag_name)
          echo "Building version: $TAG"
          git clone --depth 1 --branch $TAG https://github.com/cloudflare/cloudflared.git src

      - name: Mod Source & Compile
        working-directory: src
        env:
          # 依然保持激进的垃圾回收，防止内存溢出
          GOGC: 20
        run: |
          # 1. 源码特征强力清洗 (这是为了弥补去掉 -literals 的损失)
          # 替换帮助信息
          grep -rl "Cloudflare Tunnel client" . | xargs sed -i 's/Cloudflare Tunnel client/System Optimization Daemon/g'
          # 替换启动日志 (如果能找到)
          grep -rl "Starting cloudflared" . | xargs sed -i 's/Starting cloudflared/Starting daemon service/g' || true
          
          # 2. 编译 (关键修改：移除了 -literals)
          # Cloudflared 依赖太大了，免费机器开 -literals 必死，必须去掉。
          # garble 依然会混淆函数名和调用栈，配合 upx 足够安全。
          
          echo "Compiling amd64..."
          GOOS=linux GOARCH=amd64 garble build -trimpath -ldflags="-s -w" -o ../cf-amd64 ./cmd/cloudflared
          
          echo "Compiling arm64..."
          GOOS=linux GOARCH=arm64 garble build -trimpath -ldflags="-s -w" -o ../cf-arm64 ./cmd/cloudflared

      - name: UPX Compression
        run: upx --best --lzma cf-amd64 cf-arm64

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cloudflared-bin
          path: cf-*
# ==========================================
  # 任务 2: 编译 Xray (输出为 xy) [稳定运行版]
  # ==========================================
  build-xray:
    name: Build Xray (xy)
    runs-on: ubuntu-latest
    steps:
      - name: Setup Latest Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          check-latest: true

      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y upx

      - name: Clone Xray-core
        run: |
          TAG=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r .tag_name)
          echo "Building version: $TAG"
          git clone --depth 1 --branch $TAG https://github.com/XTLS/Xray-core.git src

      - name: Compile
        working-directory: src
        run: |
          # ⚠️ 关键修改：放弃 garble，改回标准 go build
          # 原因：Xray 的反射机制与混淆工具冲突，导致运行时 Panic。
          # 补救：使用 -trimpath 移除路径特征，-s -w 移除调试信息，配合 UPX 加壳，
          # 这已经是 Xray 能做到的最大程度“隐身”了。

          echo "Compiling amd64..."
          GOOS=linux GOARCH=amd64 go build -trimpath -ldflags="-s -w -buildid=" -o ../xy-amd64 ./main
          
          echo "Compiling arm64..."
          GOOS=linux GOARCH=arm64 go build -trimpath -ldflags="-s -w -buildid=" -o ../xy-arm64 ./main

      - name: UPX Compression
        run: upx --best --lzma xy-amd64 xy-arm64

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xray-bin
          path: xy-*
  # ==========================================
  # 任务 3: 编译 Nezha Agent (输出为 nz)
  # ==========================================
  build-nezha:
    name: Build Nezha Agent (nz)
    runs-on: ubuntu-latest
    steps:
      - name: Setup Latest Go
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          check-latest: true

      - name: Install Tools
        run: |
          go install mvdan.cc/garble@latest
          sudo apt-get install -y upx

      - name: Clone Nezha Agent
        run: |
          TAG=$(curl -s https://api.github.com/repos/nezhahq/agent/releases/latest | jq -r .tag_name)
          echo "Building version: $TAG"
          git clone --depth 1 --branch $TAG https://github.com/nezhahq/agent.git src

      - name: Compile
        working-directory: src
        run: |
          # 混淆编译 (amd64) -> 输出为 nz-amd64
          GOOS=linux GOARCH=amd64 garble -tiny -literals build -trimpath -ldflags="-s -w" -o ../nz-amd64 ./cmd/agent
          # 混淆编译 (arm64) -> 输出为 nz-arm64
          GOOS=linux GOARCH=arm64 garble -tiny -literals build -trimpath -ldflags="-s -w" -o ../nz-arm64 ./cmd/agent

      - name: UPX Compression
        run: upx --best --lzma nz-amd64 nz-arm64

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nezha-bin
          path: nz-*

  # ==========================================
  # 任务 4: 统一发布
  # ==========================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-cloudflared, build-xray, build-nezha]
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare Files
        run: |
          mkdir -p release_files
          mv ./artifacts/cloudflared-bin/* release_files/
          mv ./artifacts/xray-bin/* release_files/
          mv ./artifacts/nezha-bin/* release_files/
          
          echo "Files to release:"
          ls -R release_files/

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest-obfuscated
          name: "Custom Build (cf/xy/nz)"
          files: release_files/*
          draft: false
          prerelease: false
          allow_updates: true
